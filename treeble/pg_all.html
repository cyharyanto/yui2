<!DOCTYPE html public '-//w3c//dtd html 4.01//en' http://www.w3.org/tr/html4/strict.dtd'>
<html>
<head>
	<title>YUI 2 Treeble Example</title>
	<meta http-equiv=content-type content="text/html; charset=utf-8">

	<!-- Combo-handled YUI CSS files: -->
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.8.0r4/build/paginator/assets/skins/sam/paginator.css&2.8.0r4/build/datatable/assets/skins/sam/datatable.css">
	<!-- Combo-handled YUI JS files: -->
	<script type="text/javascript" src="http://yui.yahooapis.com/combo?2.8.0r4/build/yahoo-dom-event/yahoo-dom-event.js&2.8.0r4/build/dragdrop/dragdrop-min.js&2.8.0r4/build/element/element-min.js&2.8.0r4/build/paginator/paginator-min.js&2.8.0r4/build/datasource/datasource-min.js&2.8.0r4/build/datatable/datatable-min.js"></script>

	<script type="text/javascript" src="Treeble.js"></script>

	<style type="text/css">
	.yui-dt td.satg-treeble-nub
	{
		border-right-color: transparent;
	}

	.yui-dt .satg-row-toggle a.satg-treeble-collapse-nub
	{
		padding:0 8px;
		height:14px;
		margin-left:2px;
		*display:inline-block;
	}

	.yui-dt .satg-row-closed a.satg-treeble-collapse-nub
	{
		background:url(closed.png) no-repeat;
	}
	.yui-dt .satg-row-open a.satg-treeble-collapse-nub
	{
		background:url(open.png) no-repeat;
	}

	.yui-dt td .satg-treeble-depth-1
	{
		padding-left: 15px;
	}
	.yui-dt td .satg-treeble-depth-2
	{
		padding-left: 30px;
	}
	.yui-dt td .satg-treeble-depth-3
	{
		padding-left: 45px;
	}
	</style>
</head>
<body class="yui-skin-sam">

<script type="text/javascript">
(function(){

	// This will be obsolete when YUI 2.9 is released.

	YAHOO.namespace('hacked');

	var lang   = YAHOO.lang,
		util   = YAHOO.util,
		widget = YAHOO.widget,
		ua     = YAHOO.env.ua,

		Dom    = util.Dom,
		Ev     = util.Event,
		DS     = util.DataSourceBase,
		DT     = widget.DataTable;

	YAHOO.hacked.DataTable = function(elContainer,aColumnDefs,oDataSource,oConfigs)
	{
		if (YAHOO.lang.isFunction(oConfigs.handleDataReturnPayload)) {
			this.handleDataReturnPayload = oConfigs.handleDataReturnPayload;
		}

		YAHOO.hacked.DataTable.superclass.constructor.apply(this, arguments);
	};

	YAHOO.lang.extend(YAHOO.hacked.DataTable, YAHOO.widget.DataTable,
	{
		initAttributes : function()
		{
			YAHOO.hacked.DataTable.superclass.initAttributes.apply(this, arguments);

			/**
			 * @attribute displayAllRecords
			 * @description Set to true if you want to show all the records that were
			 * returned, not just the records that fall inside the paginator window.
			 * @type Boolean
			 * @default 0
			 */
			this.setAttributeConfig("displayAllRecords", {
				value: false,
				validator: lang.isBoolean
			});
		},

		/**
		 * Override to provide option to display all returned records, even if
		 * that is more than what paginator says is visible.
		 *
		 * @method render
		 */
		render : function() {

			this._oChainRender.stop();

			this.fireEvent("beforeRenderEvent");

			var i, j, k, len, allRecords;

			var oPaginator = this.get('paginator');
			// Paginator is enabled, show a subset of Records and update Paginator UI
			if(oPaginator && this.get('displayAllRecords')) {
				allRecords = this._oRecordSet.getRecords(
								oPaginator.getStartIndex());
			}
			else if(oPaginator) {
				allRecords = this._oRecordSet.getRecords(
								oPaginator.getStartIndex(),
								oPaginator.getRowsPerPage());
			}
			// Not paginated, show all records
			else {
				allRecords = this._oRecordSet.getRecords();
			}

			// From the top, update in-place existing rows, so as to reuse DOM elements
			var elTbody = this._elTbody,
				loopN = this.get("renderLoopSize"),
				nRecordsLength = allRecords.length;

			// Table has rows
			if(nRecordsLength > 0) {
				elTbody.style.display = "none";
				while(elTbody.lastChild) {
					elTbody.removeChild(elTbody.lastChild);
				}
				elTbody.style.display = "";

				// Set up the loop Chain to render rows
				this._oChainRender.add({
					method: function(oArg) {
						if((this instanceof DT) && this._sId) {
							var i = oArg.nCurrentRecord,
								endRecordIndex = ((oArg.nCurrentRecord+oArg.nLoopLength) > nRecordsLength) ?
										nRecordsLength : (oArg.nCurrentRecord+oArg.nLoopLength),
								elRow, nextSibling;

							elTbody.style.display = "none";

							for(; i<endRecordIndex; i++) {
								elRow = Dom.get(allRecords[i].getId());
								elRow = elRow || this._addTrEl(allRecords[i]);
								nextSibling = elTbody.childNodes[i] || null;
								elTbody.insertBefore(elRow, nextSibling);
							}
							elTbody.style.display = "";

							// Set up for the next loop
							oArg.nCurrentRecord = i;
						}
					},
					scope: this,
					iterations: (loopN > 0) ? Math.ceil(nRecordsLength/loopN) : 1,
					argument: {
						nCurrentRecord: 0,//nRecordsLength-1,  // Start at first Record
						nLoopLength: (loopN > 0) ? loopN : nRecordsLength
					},
					timeout: (loopN > 0) ? 0 : -1
				});

				// Post-render tasks
				this._oChainRender.add({
					method: function(oArg) {
						if((this instanceof DT) && this._sId) {
							while(elTbody.rows.length > nRecordsLength) {
								elTbody.removeChild(elTbody.lastChild);
							}
							this._setFirstRow();
							this._setLastRow();
							this._setRowStripes();
							this._setSelections();
						}
					},
					scope: this,
					timeout: (loopN > 0) ? 0 : -1
				});

			}
			// Table has no rows
			else {
				// Set up the loop Chain to delete rows
				var nTotal = elTbody.rows.length;
				if(nTotal > 0) {
					this._oChainRender.add({
						method: function(oArg) {
							if((this instanceof DT) && this._sId) {
								var i = oArg.nCurrent,
									loopN = oArg.nLoopLength,
									nIterEnd = (i - loopN < 0) ? -1 : i - loopN;

								elTbody.style.display = "none";

								for(; i>nIterEnd; i--) {
									elTbody.deleteRow(-1);
								}
								elTbody.style.display = "";

								// Set up for the next loop
								oArg.nCurrent = i;
							}
						},
						scope: this,
						iterations: (loopN > 0) ? Math.ceil(nTotal/loopN) : 1,
						argument: {
							nCurrent: nTotal,
							nLoopLength: (loopN > 0) ? loopN : nTotal
						},
						timeout: (loopN > 0) ? 0 : -1
					});
				}
			}
			this._runRenderChain();
		}
	});

})();

YAHOO.util.Event.onDOMReady(function(){

	YAHOO.namespace('example');

	var Dom = YAHOO.util.Dom,
		Event = YAHOO.util.Event,
		DT = YAHOO.widget.DataTable;

	YAHOO.example.Data = {
		bookorders: [
			{title:"Fantasy",
				kiddies:
				[
					{year:"1898-1963", title:"C.S. Lewis",
						kiddies:
						[
							{year:"1950-1956", title:"Narnia",
								kiddies:
								[
									{year:1950, quantity:10, title:"The Lion, the Witch and the Wardrobe"},
									{year:1951, quantity:5, title:"Prince Caspian: The Return to Narnia"},
									{year:1952, quantity:2, title:"The Voyage of the Dawn Treader"},
									{year:1953, quantity:6, title:"The Silver Chair"},
									{year:1954, quantity:9, title:"The Horse and His Boy"},
									{year:1955, quantity:4, title:"The Magician's Nephew"},
									{year:1956, quantity:8, title:"The Last Battle"}
								]},
							{year:"1938-1945", title:"Space Trilogy",
								kiddies:
								[
									{year:1938, quantity:10, title:"Out of the Silent Planet"},
									{year:1943, quantity:5, title:"Perelandra"},
									{year:1945, quantity:2, title:"That Hideous Strength"}
								]}
						]},
					{year:"1946-", title:"Philip Pullman",
						kiddies:
						[
							{year:"1995-2000", title:"His Dark Materials",
								kiddies:
								[
									{year:1995, quantity:7, title:"Northern Lights"},
									{year:1997, quantity:5, title:"The Subtle Knife"},
									{year:2000, quantity:8, title:"The Amber Spyglass"}
								]}
						]},
					{year:"1892-1973", title:"J. R. R. Tolkien",
						kiddies:
						[
							{year:1937, quantity:5, title:"The Hobbit"},
							{year:"1937-1949", title:"The Lord of the Rings",
								kiddies:
								[
									{year:1955, quantity:12, title:"The Fellowship of the Ring"},
									{year:1955, quantity:0, title:"The Two Towers"},
									{year:1955, quantity:8, title:"The Return of the King"}
								]}
						]}
				]},
			{title:"Science Fiction",
				kiddies:
				[
					{year:"1928-1982", title:"Philip K. Dick",
						kiddies:
						[
							{year:1966, quantity:5, title:"Do Androids Dream of Electric Sheep?"}
						]},
					{year:"1907-1988", title:"Robert A. Heinlein",
						kiddies:
						[
							{year:1959, quantity:4, title:"Starship Troopers"},
							{year:1961, quantity:7, title:"Stranger in a Strange Land"},
							{year:1966, quantity:3, title:"The Moon Is a Harsh Mistress"}
						]},
					{year:"1912-2000", title:"A. E. van Vogt",
						kiddies:
						[
							{year:1946, quantity:3, title:"Slan"},
							{year:1950, quantity:5, title:"The Voyage of the Space Beagle"},
							{year:1970, quantity:8, title:"Quest for the Future"}
						]}
				]},
			{title:"Xenobiology"}
		]
	};


	// Local datasource

	function localGenerateRequest(state, path)
	{
		return state;
	};

	YAHOO.example.localDataTable = new YAHOO.hacked.DataTable(

		//Root element id
		"table", 

		//Column configuration
		[
			{key:"toggle_column", label:"", formatter:
				function(elCell, oRecord, oColumn, oData)
				{
					Dom.addClass(elCell.parentNode, 'satg-treeble-nub');
					if (oRecord.getData('kiddies'))
					{
						var path  = oRecord.getData('_yui_node_path');
						var open  = this.rowIsOpen(path);
						var clazz = open ? 'satg-row-open' : 'satg-row-closed';

						Dom.addClass(elCell, 'satg-row-toggle');
						Dom.replaceClass(elCell, /satg-row-(open|closed)/, clazz);
						elCell.innerHTML = '<a class="satg-treeble-collapse-nub" href="javascript:void(0);"></a>';

						Event.on(elCell, 'click', function(e, path)
						{
							this.toggleRow(path);
						},
						path, this);
					}
				}
			},
			{key:"title", label:"Title", resizeable:true,
				formatter: function(elCell, oRecord, oColumn, oData)
				{
					var depth_class  = 'satg-treeble-depth-'+oRecord.getData('_yui_node_depth');
					elCell.innerHTML = '<span class="'+depth_class+'">'+oData+'</span>';
				}},
			{key:"year", label:"Year", resizeable:true},
			{key:"quantity", label:"Quantity", resizeable:true, editor:new YAHOO.widget.TextboxCellEditor({validator:DT.validateNumber})}
		],

		//Data Source 
		new YAHOO.util.TreebleDataSource(
			new YAHOO.util.DataSource(
				YAHOO.example.Data.bookorders,
				{
					responseType: YAHOO.util.DataSource.TYPE_JSARRAY,
					responseSchema:
					{
						fields:
						[
							"id","quantity","year","title",
							{key: 'kiddies', parser: 'datasource'}
						]
					}
				}
			),
			{
				paginateChildren:       true,
				generateRequest:        localGenerateRequest,
				totalRecordsReturnExpr: '.meta.totalRecords'
			}
		),

		//Attribute Config
		{
			paginator: new YAHOO.widget.Paginator({
				rowsPerPage:5,
				rowsPerPageOptions:[1,2,5,10,25,50],
				containers:'table-pagination',
				template:'{FirstPageLink}{PreviousPageLink}{PageLinks}{NextPageLink}{LastPageLink}{RowsPerPageDropdown}'
			}),
			initialRequest: {startIndex:0,results:5},
			dynamicData: true,
			displayAllRecords: false,
			generateRequest: DT.generateTreebleDataSourceRequest,
			handleDataReturnPayload: function(oRequest, oResponse, oPayload)
			{
				oPayload.totalRecords = oResponse.meta.totalRecords;
				return oPayload;
			}
		}
	);

	// Cell editing

	function highlightEditableCell(oArgs)
	{
		var elCell = oArgs.target;
		var rec    = this.getRecord(elCell);
		if (Dom.hasClass(elCell, "yui-dt-editable") &&
			YAHOO.lang.isNumber(rec.getData("quantity")))
		{
			this.highlightCell(elCell);
		}
	}

	function editCell(oArgs)
	{
		var elCell = oArgs.target;
		var rec    = this.getRecord(elCell);
		if (Dom.hasClass(elCell, "yui-dt-editable") &&
			YAHOO.lang.isNumber(rec.getData("quantity")))
		{
			this.onEventShowCellEditor(oArgs);
		}
	}

	function saveValue(oArgs)
	{
		// This is a rather strange thing to do, but it demonstrates
		// that we can get the DataSource and modify the value.  An XHR
		// request would make more sense, but the data happens to be local.

		var rec  = oArgs.editor.getRecord();
		var ds   = rec.getData('_yui_node_ds');
		var path = rec.getData('_yui_node_path');
		ds.liveData[ path[ path.length-1 ] ].quantity = oArgs.newData;
	}

	YAHOO.example.localDataTable.subscribe("cellMouseoverEvent", highlightEditableCell);
	YAHOO.example.localDataTable.subscribe("cellMouseoutEvent", YAHOO.example.localDataTable.onEventUnhighlightCell);
	YAHOO.example.localDataTable.subscribe("cellClickEvent", editCell);
	YAHOO.example.localDataTable.subscribe("editorSaveEvent", saveValue);
});
</script>


<h1>YUI 2 Treeble Example</h1>

<div id="table"></div>
<div id="table-pagination"></div>
<p><a href="index.html">I want to paginate only top-level nodes instead</a></p>

</body>
</html>
